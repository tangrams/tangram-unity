cmake_minimum_required(VERSION 2.8.12)
project(Earcut)

macro(copy_unity_plugin_files PLUGIN_PLATFORM_NAME)
  message(STATUS "${PLUGIN_PLATFORM_NAME} native plugin files will be copied to ${UNITY_ASSET_PATH}/${PLUGIN_PLATFORM_NAME}")
  set(CMAKE_DOCS "/!\\ THIS FILE IS PART OF PLUGIN CODE FOR THE ${PLUGIN_PLATFORM_NAME} PLATFORM -- DO NOT EDIT")
  set(CONFIGURED_FILES "")
  foreach(_source ${SOURCES})
    get_filename_component(FILE_NAME ${_source} NAME)
    set(CONFIGURED_FILE ${CMAKE_BINARY_DIR}/${FILE_NAME})
    configure_file(${_source} ${CONFIGURED_FILE})
    file(COPY ${CONFIGURED_FILE} DESTINATION ${UNITY_ASSET_PATH}/${PLUGIN_PLATFORM_NAME}/)
  endforeach()
endmacro(copy_unity_plugin_files)

set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -O3")
set(NATIVE_PLUGIN Earcut)
set(UNITY_ASSET_PATH ${PROJECT_SOURCE_DIR}/../Assets/Plugins)

file(GLOB SOURCES "${PROJECT_SOURCE_DIR}/earcut/*.h" "${PROJECT_SOURCE_DIR}/earcut/*.cpp")

if(IOS)
  copy_unity_plugin_files(iOS)
elseif(WEBGL)
  set(NATIVE_PLUGIN ${NATIVE_PLUGIN})
  add_library(${NATIVE_PLUGIN} SHARED ${SOURCES})
  set_target_properties(${NATIVE_PLUGIN} PROPERTIES PREFIX "" SUFFIX ".bc")
  install(TARGETS ${NATIVE_PLUGIN} DESTINATION ${UNITY_ASSET_PATH}/WebGL)
elseif(ANDROID)
  set(NATIVE_PLUGIN ${NATIVE_PLUGIN})
  add_library(${NATIVE_PLUGIN} SHARED ${SOURCES})
elseif(APPLE)
  add_library(${NATIVE_PLUGIN} MODULE ${SOURCES})
  set_target_properties(${NATIVE_PLUGIN} PROPERTIES
    BUNDLE TRUE
    MACOSX_BUNDLE_INFO_PLIST ${PROJECT_SOURCE_DIR}/Info.plist)
  install(TARGETS ${NATIVE_PLUGIN} DESTINATION ${UNITY_ASSET_PATH})
elseif(WIN32 OR UNIX AND NOT APPLE)
  if(UNIX)
    set(PLATFORM Linux)
  else()
    set(PLATFORM Windows)
  endif()
  set(SUPPORTED_ARCHS x86 x86_64)
  if(NOT ARCH)
    set(ARCH x86)
    message(STATUS "Configuration for x86 architecture")
  else()
    list(FIND SUPPORTED_ARCHS ${ARCH} ARCH_IN_LIST)
    if(ARCH_IN_LIST EQUAL -1)
      message(SEND_ERROR "Please select a valid architecture (x86 or x86_64) using -DARCH=")
      return()
    endif()
  endif()
  set(CMAKE_LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/${ARCH}")
  add_library(${NATIVE_PLUGIN} MODULE ${SOURCES})
  if(UNIX)
    if(ARCH STREQUAL "x86")
      set_target_properties(${NATIVE_PLUGIN} PROPERTIES COMPILE_FLAGS "-m32" LINK_FLAGS "-m32")
    elseif(ARCH STREQUAL "x86_64")
      set_target_properties(${NATIVE_PLUGIN} PROPERTIES COMPILE_FLAGS "-m64" LINK_FLAGS "-m64")
    endif()
  endif()
  install(TARGETS ${NATIVE_PLUGIN} DESTINATION ${UNITY_ASSET_PATH}/${PLATFORM}/${ARCH}/)
else()
  message(SEND_ERROR "Unsupported platform")
  return()
endif()

